<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Xs Watersports</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
<div id='map' style='width: 400px; height: 300px;'></div>
<script>
    let Latitude;
    let Longitude;
    showMap();



    // Create a GeoJSON source with an empty lineString.
    var geojson = {
        'type': 'FeatureCollection',
        'features': [
            {
                'type': 'Feature',
                'geometry': {
                    'type': 'LineString',
                    'coordinates': []
                }
            }
        ]
    };

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
    }
    else {
        document.getElementById("error").innerHTML = "Geolocation is not supported by your browser."; //TODO - Geolocation is NOT supported by browser.
    }

    function showPosition(position)
    {
        Latitude = position.coords.latitude;
        Longitude = position.coords.longitude;
        // LatitudeArr.push(Latitude);
        // LongitudeArr.push(Longitude);
        // let lat = JSON.stringify(LatitudeArr);
        // let long = JSON.stringify(LongitudeArr);
        showMap();
        console.log(Latitude + ", " + Longitude)
    }

    function showMap(){


        mapboxgl.accessToken = 'pk.eyJ1Ijoia3N0eWxpYW5vdSIsImEiOiJja2w4OWdlY3owZHFqMndydnlqYWdwODhzIn0.5p3nIkXRh8PeBiM-caYVJQ';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [34.054960,35.015934],
            zoom: 15,
        });

        window.addEventListener("deviceorientation", handleOrientation, true);
        function handleOrientation(event) {
            let alpha = event.alpha;
            map.setBearing(alpha);
        }


        map.on('load', function () {
            window.setInterval(function () {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(show);
                    // retrieve the JSON from the response
                    function show(position) {
                        geojson.features[0].geometry.coordinates.push([position.coords.longitude, position.coords.latitude])
                        console.log(geojson);
                        // update the drone symbol's location on the map
                        map.getSource('drone').setData(geojson);
                        map.getSource('line').setData(geojson)


                        // fly the map to the drone's current location
                        map.flyTo({
                            center: geojson.features[0].geometry.coordinates[geojson.features[0].geometry.coordinates.length-1],
                            speed: 0.5,
                            zoom: 15
                        });
                    }
                }
            }, 2000);



            map.addSource('drone', { type: 'geojson', data: geojson });
            map.addLayer({
                'id': 'drone',
                'type': 'symbol',
                'source': 'drone',
                'layout': {
                    'icon-image': 'triangle-15'
                }
            });

            map.addSource('line', {
                'type': 'geojson',
                'data': geojson
            });

            // add the line which will be modified in the animation
            map.addLayer({
                'id': 'line-animation',
                'type': 'line',
                'source': 'line',
                'layout': {
                    'line-cap': 'round',
                    'line-join': 'round'
                },
                'paint': {
                    'line-color': '#ed6498',
                    'line-width': 5,
                    'line-opacity': 0.8
                }
            });
        });
    }


</script>
</body>
</html>